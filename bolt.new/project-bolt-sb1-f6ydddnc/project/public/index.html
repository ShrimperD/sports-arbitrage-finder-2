<!DOCTYPE html>
<html>
<head>
    <title>Sports Arbitrage Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card { @apply bg-white dark:bg-gray-800 rounded-lg shadow p-4; }
        .button { @apply bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700; }
        .input { @apply border rounded px-2 py-1.5 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white; }
        .label { @apply block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1; }
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            align-items: end;
        }
        .sticky-header {
            @apply bg-gray-100 dark:bg-gray-800;
            padding: 0.5rem;
        }
        .loading {
            @apply animate-pulse bg-gray-200 dark:bg-gray-700 rounded;
        }
        .tooltip {
            @apply invisible absolute bg-gray-800 dark:bg-gray-700 text-white text-xs rounded py-1 px-2 -mt-1;
        }
        .has-tooltip:hover .tooltip {
            @apply visible z-50;
        }
        .opportunity-card {
            @apply bg-white dark:bg-gray-800 border dark:border-gray-700;
        }
        .opportunity-card.pinned {
            @apply border-blue-500 dark:border-blue-400 border-2;
        }
        .opportunity-card.bet {
            @apply border-green-500 dark:border-green-400 border-2;
            background-color: rgba(239, 68, 68, 0.2);
        }
        /* Mobile-friendly styles */
        @media (max-width: 768px) {
            .sticky-header {
                padding: 0.25rem;
            }
            .card {
                padding: 0.75rem;
            }
            .grid {
                gap: 0.5rem;
            }
            .text-2xl {
                font-size: 1.25rem;
            }
            .settings-grid {
                grid-template-columns: 1fr;
            }
            .opportunity-card {
                padding: 0.75rem;
            }
            .opportunity-card .grid {
                grid-template-columns: 1fr;
            }
            .mobile-menu {
                @apply fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-2 z-50;
            }
            .mobile-menu .grid {
                @apply grid-cols-3 gap-2;
            }
            .mobile-menu .button {
                @apply w-full text-center;
            }
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, 20px); }
            20% { opacity: 1; transform: translate(-50%, 0); }
            80% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }
        .animate-fade-in-out {
            animation: fadeInOut 2s ease-in-out forwards;
        }
        .opportunity-card {
            @apply bg-white dark:bg-gray-800 border dark:border-gray-700 transition-all duration-200;
        }
        .opportunity-card:hover {
            @apply shadow-lg transform -translate-y-0.5;
        }
        .opportunity-card .bet-details {
            @apply opacity-0 transition-opacity duration-200;
        }
        .opportunity-card:hover .bet-details {
            @apply opacity-100;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="max-w-7xl mx-auto px-4">
        <div class="sticky-header">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                <h1 class="text-2xl font-bold mb-2 md:mb-0">Sports Arbitrage Finder</h1>
                <div class="flex items-center gap-4">
                    <button onclick="updateOpportunities()" class="button text-xs py-1" id="refreshButton">
                        <span class="button-text">Refresh</span>
                        <span class="loading-spinner hidden">
                            <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </button>
                    <button onclick="toggleDarkMode()" class="button text-xs py-1" id="darkModeButton">
                        <span class="dark:hidden">üåô</span>
                        <span class="hidden dark:inline">‚òÄÔ∏è</span>
                    </button>
                    <div class="text-xs text-gray-600 dark:text-gray-400">
                        <span>API: </span>
                        <span>Requests: <span id="requestsRemaining">-</span> | </span>
                        <span>Updated: <span id="lastUpdated">Never</span></span>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                <!-- Settings - 12 columns -->
                <div class="col-span-1 md:col-span-12">
                    <div class="card">
                        <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                            <div class="col-span-1 md:col-span-1">
                                <label class="label">Sport</label>
                                <select class="input w-full text-sm" id="sportSelect">
                                    <option value="all">All Sports</option>
                                </select>
                            </div>
                            <div class="col-span-1 md:col-span-1">
                                <label class="label">Min Return (%)</label>
                                <input type="number" class="input w-full" id="minReturn" value="0.5" min="0" step="0.1">
                            </div>
                            <div class="col-span-1 md:col-span-1">
                                <label class="label">Max Stake ($)</label>
                                <input type="number" class="input w-full" id="maxStake" value="100" min="100" step="100">
                            </div>
                            <div class="col-span-1 md:col-span-1">
                                <label class="label">Min Profit ($)</label>
                                <input type="number" class="input w-full" id="minProfit" value="20" min="0" step="1">
                            </div>
                            <div class="col-span-1 md:col-span-1">
                                <label class="label">Sort By</label>
                                <select class="input w-full text-sm" id="sortSelect">
                                    <option value="time">Game Time</option>
                                    <option value="return">Return % (High-Low)</option>
                                    <option value="profit">Profit $ (High-Low)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Bookmakers as tags -->
                        <div class="mt-3">
                            <label class="label mb-1">Bookmakers</label>
                            <div id="bookmakerFilters" class="flex flex-wrap gap-1">
                                <!-- Bookmaker buttons will be added here -->
                            </div>
                            <div class="mt-1">
                                <button onclick="selectAllBookmakers(true)" class="text-xs text-blue-600 hover:underline">Select All</button>
                                <span class="text-gray-300 mx-1">|</span>
                                <button onclick="selectAllBookmakers(false)" class="text-xs text-blue-600 hover:underline">Deselect All</button>
                            </div>
                        </div>

                        <!-- Simplified Hedge Calculator -->
                        <div class="mt-4 pt-4 border-t dark:border-gray-700">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <input type="text" class="input w-full text-sm" id="originalOdds" placeholder="Original Odds (+150)">
                                </div>
                                <div>
                                    <input type="text" class="input w-full text-sm" id="originalBetAmount" value="100">
                                </div>
                                <div>
                                    <input type="text" class="input w-full text-sm" id="hedgeOdds" placeholder="Hedge Odds (-130)">
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1">
                                        <div class="text-xs text-gray-600 dark:text-gray-400">Hedge: <span id="idealHedgeAmount" class="font-medium">$0.00</span></div>
                                        <div class="text-xs text-gray-600 dark:text-gray-400">Total: <span id="totalBetAmount" class="font-medium">$0.00</span></div>
                                        <div class="text-xs text-green-600 dark:text-green-400">Profit: <span id="totalProfit" class="font-medium">$0.00</span></div>
                                    </div>
                                    <button onclick="resetCalculator()" class="text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">Reset</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <h2 class="text-lg font-bold mb-4">Live Opportunities</h2>
            <!-- Add pinned opportunities section -->
            <div id="pinnedOpportunities" class="space-y-3 mb-4" style="display: none;">
                <h3 class="text-sm font-bold text-blue-600 mb-2">Pinned Opportunities</h3>
                <div class="pinned-container"></div>
            </div>
            <div id="opportunities" class="space-y-3">
                <div class="text-center text-gray-500 py-4">
                    Select a sport to view opportunities
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-menu md:hidden">
        <div class="grid">
            <button onclick="scrollToTop()" class="button">
                <span>‚Üë</span>
            </button>
            <button onclick="updateOpportunities()" class="button">
                <span>‚Üª</span>
            </button>
            <button onclick="toggleDarkMode()" class="button">
                <span class="dark:hidden">üåô</span>
                <span class="hidden dark:inline">‚òÄÔ∏è</span>
            </button>
        </div>
    </div>

    <script>
        const API_KEY = '4a0183ff75bc6a57c88422076c0f350b';
        const BASE_URL = 'https://api.the-odds-api.com/v4/sports';
        
        // Define preferred bookmakers and excluded bookmakers
        const PREFERRED_BOOKMAKERS = new Set([
            'ESPN Bets',
            'BetAnySports',
            'Hardrock Bet',
            'BetOpenly',
            'Novig',
            'ProphetX',
            'Caesars',
            'Fanatics',
            'FanDuel',
            'DraftKings',
            'BetMGM',
            'BetOnline',
            'BetUS',
            'LowVig.ag',
            'MyBookie.ag'
        ]);
        
        const EXCLUDED_BOOKMAKERS = new Set([
            'BetRivers',
            'Bovada'
        ]);

        let opportunities = [];
        let allSports = [];
        let sportOpportunities = new Map();
        let bookmakers = new Set();
        let selectedBookmakers = new Set();
        let pinnedOpportunities = new Map(); // Store pinned opportunities
        let betOpportunities = new Set(); // Store bet opportunities

        // Load saved bookmaker selections from localStorage
        function loadSavedBookmakers() {
            const saved = localStorage.getItem('selectedBookmakers');
            if (saved) {
                selectedBookmakers = new Set(JSON.parse(saved));
            }
        }

        function updateBookmakerFilters() {
            const container = document.getElementById('bookmakerFilters');
            const sortedBookmakers = Array.from(bookmakers)
                .filter(b => !EXCLUDED_BOOKMAKERS.has(b)) // Filter out excluded bookmakers
                .sort((a, b) => {
                    // Sort preferred bookmakers first
                    if (PREFERRED_BOOKMAKERS.has(a) && !PREFERRED_BOOKMAKERS.has(b)) return -1;
                    if (!PREFERRED_BOOKMAKERS.has(a) && PREFERRED_BOOKMAKERS.has(b)) return 1;
                    return a.localeCompare(b);
                });
            
            if (selectedBookmakers.size === 0 && !localStorage.getItem('selectedBookmakers')) {
                // Only select from preferred bookmakers initially
                sortedBookmakers
                    .filter(b => PREFERRED_BOOKMAKERS.has(b))
                    .forEach(b => selectedBookmakers.add(b));
            }
            
            container.innerHTML = sortedBookmakers.map(bookmaker => `
                <div class="inline-flex items-center">
                    <input type="checkbox" 
                           id="bookmaker-${bookmaker.replace(/\s+/g, '-')}" 
                           value="${bookmaker}"
                           ${selectedBookmakers.has(bookmaker) ? 'checked' : ''}
                           class="form-checkbox h-3 w-3"
                           onchange="toggleBookmaker('${bookmaker}')"
                    >
                    <label for="bookmaker-${bookmaker.replace(/\s+/g, '-')}" class="ml-1 text-xs">
                        ${bookmaker}
                        ${PREFERRED_BOOKMAKERS.has(bookmaker) ? '<span class="text-blue-500 ml-1">‚òÖ</span>' : ''}
                    </label>
                </div>
            `).join('');
        }

        function toggleBookmaker(bookmaker) {
            if (selectedBookmakers.has(bookmaker)) {
                selectedBookmakers.delete(bookmaker);
            } else {
                selectedBookmakers.add(bookmaker);
            }
            localStorage.setItem('selectedBookmakers', JSON.stringify(Array.from(selectedBookmakers)));
            updateBookmakerFilters();
            // Update opportunities immediately when bookmakers are toggled
            updateOpportunities();
        }

        function selectAllBookmakers(select) {
            if (select) {
                bookmakers.forEach(b => selectedBookmakers.add(b));
            } else {
                selectedBookmakers.clear();
            }
            localStorage.setItem('selectedBookmakers', JSON.stringify(Array.from(selectedBookmakers)));
            updateBookmakerFilters();
            // Update opportunities immediately when bookmakers are toggled
            updateOpportunities();
        }

        function updateSportCounts() {
            // Reset all counts
            sportOpportunities.clear();
            sportOpportunities.set('all', 0);
            
            // Count opportunities for each sport
            opportunities.forEach(opp => {
                const sport = opp.sport;
                sportOpportunities.set(sport, (sportOpportunities.get(sport) || 0) + 1);
                sportOpportunities.set('all', sportOpportunities.get('all') + 1);
            });

            // Update the dropdown options
            const select = document.getElementById('sportSelect');
            const selectedValue = select.value;
            
            // Update "All Sports" count
            select.options[0].textContent = `All Sports (${sportOpportunities.get('all') || 0})`;
            
            // Update other sports counts
            for (let i = 1; i < select.options.length; i++) {
                const option = select.options[i];
                const sport = allSports.find(s => s.key === option.value);
                if (sport) {
                    const count = sportOpportunities.get(sport.title) || 0;
                    option.textContent = `${sport.title} (${count})`;
                }
            }

            // Restore selected value
            select.value = selectedValue;
        }

        async function fetchSports() {
            try {
                console.log('Fetching sports...');
                const response = await fetch(`${BASE_URL}?apiKey=${API_KEY}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const sports = await response.json();
                console.log('Sports fetched:', sports);
                allSports = sports;
                const select = document.getElementById('sportSelect');
                
                // Clear existing options except "All Sports"
                select.innerHTML = '<option value="all">All Sports (0)</option>';
                
                sports.forEach(sport => {
                    const option = document.createElement('option');
                    option.value = sport.key;
                    option.textContent = `${sport.title} (0)`;
                    select.appendChild(option);
                });

                updateRequestsRemaining(response.headers);
                
                // Initial load of all sports data
                updateOpportunities();
            } catch (error) {
                console.error('Error fetching sports:', error);
                document.getElementById('opportunities').innerHTML = `
                    <div class="text-center text-red-500 py-4">
                        Error fetching sports: ${error.message}
                    </div>
                `;
            }
        }

        async function fetchOdds(sportKey) {
            try {
                console.log(`Fetching odds for ${sportKey}...`);
                const response = await fetch(
                    `${BASE_URL}/${sportKey}/odds?apiKey=${API_KEY}&regions=us&markets=h2h`
                );
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const events = await response.json();
                console.log(`Odds fetched for ${sportKey}:`, events);
                updateRequestsRemaining(response.headers);
                return events;
            } catch (error) {
                console.error(`Error fetching odds for ${sportKey}:`, error);
                return [];
            }
        }

        async function fetchAllSportsOdds() {
            try {
                // Use Promise.all to fetch all sports concurrently
                const promises = allSports.map(sport => 
                    fetchOdds(sport.key)
                        .then(events => events.map(event => ({ ...event, sport: sport.title })))
                        .catch(error => {
                            console.error(`Error fetching odds for ${sport.title}:`, error);
                            return []; // Return empty array on error to continue with other sports
                        })
                );
                
                const results = await Promise.all(promises);
                return results.flat(); // Combine all events into a single array
            } catch (error) {
                console.error('Error fetching all sports odds:', error);
                return [];
            }
        }

        function formatGameTime(isoString) {
            const date = new Date(isoString);
            // Convert to Central Time
            const cstDate = new Date(date.toLocaleString('en-US', { timeZone: 'America/Chicago' }));
            
            // Format date and time
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            let dateStr;
            if (cstDate.toDateString() === today.toDateString()) {
                dateStr = 'Today';
            } else if (cstDate.toDateString() === tomorrow.toDateString()) {
                dateStr = 'Tomorrow';
            } else {
                dateStr = cstDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            }
            
            // Format time in 12-hour format
            const timeStr = cstDate.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit', 
                hour12: true 
            });
            
            return `${dateStr} ${timeStr} CST`;
        }

        function findArbitrageOpportunities(events) {
            console.log('Processing events:', events);
            // First, update our bookmakers set with any new bookmakers
            events.forEach(event => {
                if (event.bookmakers) {
                    event.bookmakers.forEach(b => {
                        if (b.title && !EXCLUDED_BOOKMAKERS.has(b.title)) {
                            bookmakers.add(b.title);
                            // Add to selected bookmakers if it's new and preferred
                            if (!selectedBookmakers.has(b.title) && PREFERRED_BOOKMAKERS.has(b.title)) {
                                selectedBookmakers.add(b.title);
                            }
                        }
                    });
                }
            });
            
            console.log('Available bookmakers:', Array.from(bookmakers));
            console.log('Selected bookmakers:', Array.from(selectedBookmakers));
            
            // Update the bookmaker filter buttons
            updateBookmakerFilters();

            const opportunities = [];
            const minReturn = parseFloat(document.getElementById('minReturn').value) || 0.5;
            const maxStake = parseFloat(document.getElementById('maxStake').value) || 100;

            events.forEach(event => {
                // Filter bookmakers based on selection and exclusions
                const filteredBookmakers = event.bookmakers?.filter(b => 
                    selectedBookmakers.has(b.title) && !EXCLUDED_BOOKMAKERS.has(b.title)
                ) || [];
                if (!filteredBookmakers || filteredBookmakers.length < 2) return;

                const bestOdds = {
                    home: { odds: 0, bookmaker: '' },
                    away: { odds: 0, bookmaker: '' }
                };

                filteredBookmakers.forEach(bookmaker => {
                    const market = bookmaker.markets.find(m => m.key === 'h2h');
                    if (!market) return;

                    const homeOdds = market.outcomes.find(o => o.name === event.home_team)?.price;
                    const awayOdds = market.outcomes.find(o => o.name === event.away_team)?.price;

                    if (homeOdds && homeOdds > bestOdds.home.odds) {
                        bestOdds.home = { odds: homeOdds, bookmaker: bookmaker.title };
                    }
                    if (awayOdds && awayOdds > bestOdds.away.odds) {
                        bestOdds.away = { odds: awayOdds, bookmaker: bookmaker.title };
                    }
                });

                const impliedProbHome = 1 / bestOdds.home.odds;
                const impliedProbAway = 1 / bestOdds.away.odds;
                const totalImpliedProb = impliedProbHome + impliedProbAway;

                if (totalImpliedProb < 1) {
                    const returnPercentage = ((1 / totalImpliedProb) - 1) * 100;
                    if (returnPercentage >= minReturn) {
                        const totalStake = maxStake;
                        // Round stakes to whole numbers
                        const homeStake = Math.round(totalStake * impliedProbHome / totalImpliedProb);
                        const awayStake = Math.round(totalStake * impliedProbAway / totalImpliedProb);

                        // Adjust stakes to ensure total is exactly maxStake
                        const totalCalculatedStake = homeStake + awayStake;
                        let adjustedHomeStake = homeStake;
                        let adjustedAwayStake = awayStake;
                        
                        if (totalCalculatedStake !== totalStake) {
                            // Add or subtract the difference from the larger stake
                            const difference = totalStake - totalCalculatedStake;
                            if (homeStake > awayStake) {
                                adjustedHomeStake = homeStake + difference;
                            } else {
                                adjustedAwayStake = awayStake + difference;
                            }
                        }

                        // Generate a unique ID for the opportunity
                        const id = `${event.id || Date.now()}-${event.home_team}-${event.away_team}`.replace(/\s+/g, '-');

                        opportunities.push({
                            id,
                            homeTeam: event.home_team,
                            awayTeam: event.away_team,
                            sport: event.sport || 'Unknown',
                            return: returnPercentage,
                            commenceTime: event.commence_time,
                            bets: [
                                {
                                    team: event.home_team,
                                    odds: bestOdds.home.odds,
                                    bookmaker: bestOdds.home.bookmaker,
                                    stake: adjustedHomeStake
                                },
                                {
                                    team: event.away_team,
                                    odds: bestOdds.away.odds,
                                    bookmaker: bestOdds.away.bookmaker,
                                    stake: adjustedAwayStake
                                }
                            ]
                        });
                    }
                }
            });

            // Sort opportunities by game time
            return opportunities.sort((a, b) => new Date(a.commenceTime) - new Date(b.commenceTime));
        }

        function updateRequestsRemaining(headers) {
            const remaining = headers.get('x-requests-remaining');
            document.getElementById('requestsRemaining').textContent = remaining || 'Unknown';
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        }

        function sortOpportunities(opportunities, sortBy) {
            const minProfit = parseFloat(document.getElementById('minProfit').value) || 0;
            const maxStake = parseFloat(document.getElementById('maxStake').value) || 100;

            // Filter by minimum profit first
            opportunities = opportunities.filter(opp => 
                (opp.return * maxStake / 100) >= minProfit
            );

            switch (sortBy) {
                case 'return':
                    return opportunities.sort((a, b) => b.return - a.return);
                case 'profit':
                    return opportunities.sort((a, b) => {
                        const profitA = (a.return * maxStake / 100);
                        const profitB = (b.return * maxStake / 100);
                        return profitB - profitA;
                    });
                case 'time':
                default:
                    return opportunities.sort((a, b) => new Date(a.commenceTime) - new Date(b.commenceTime));
            }
        }

        function convertDecimalToAmerican(decimal) {
            if (decimal >= 2) {
                return Math.round((decimal - 1) * 100);
            } else {
                return Math.round(-100 / (decimal - 1));
            }
        }

        function convertDecimalToFractional(decimal) {
            const tolerance = 1.0E-6;
            let h1 = 1;
            let h2 = 0;
            let k1 = 0;
            let k2 = 1;
            let b = decimal;
            do {
                let a = Math.floor(b);
                let aux = h1;
                h1 = a * h1 + h2;
                h2 = aux;
                aux = k1;
                k1 = a * k1 + k2;
                k2 = aux;
                b = 1 / (b - a);
            } while (Math.abs(decimal - h1 / k1) > decimal * tolerance);
            return `${h1}/${k1}`;
        }

        function formatOdds(decimal) {
            const american = convertDecimalToAmerican(decimal);
            const fractional = convertDecimalToFractional(decimal);
            return {
                decimal: decimal.toFixed(2),
                american: american > 0 ? `+${american}` : american.toString(),
                fractional: fractional
            };
        }

        function formatOpportunityText(opp) {
            const odds1 = formatOdds(opp.bets[0].odds);
            const odds2 = formatOdds(opp.bets[1].odds);
            return `${opp.homeTeam} vs ${opp.awayTeam}
${opp.sport} - ${formatGameTime(opp.commenceTime)}
Return: ${opp.return.toFixed(2)}% ($${(opp.return * parseFloat(document.getElementById('maxStake').value) / 100).toFixed(2)})

Bet 1: ${opp.bets[0].team}
${opp.bets[0].bookmaker}
Stake: $${parseFloat(opp.bets[0].stake).toFixed(2)}
Odds: ${odds1.decimal} (${odds1.american})

Bet 2: ${opp.bets[1].team}
${opp.bets[1].bookmaker}
Stake: $${parseFloat(opp.bets[1].stake).toFixed(2)}
Odds: ${odds2.decimal} (${odds2.american})`;
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showToast('Copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showToast('Failed to copy to clipboard');
            }
        }

        function handleCopyDetails(opp) {
            copyToClipboard(formatOpportunityText(opp));
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded shadow-lg z-50 animate-fade-in-out';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        function displayOpportunities() {
            const container = document.getElementById('opportunities');
            
            // Display pinned opportunities first
            displayPinnedOpportunities();
            
            // Update sport counts first
            updateSportCounts();
            
            if (opportunities.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        No arbitrage opportunities found for the selected sport
                    </div>
                `;
                return;
            }

            // Sort opportunities based on selected criteria
            const sortBy = document.getElementById('sortSelect').value;
            const sortedOpportunities = sortOpportunities([...opportunities], sortBy);

            // Create a grid container for the opportunities
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${sortedOpportunities.map(opp => {
                        const odds1 = formatOdds(opp.bets[0].odds);
                        const odds2 = formatOdds(opp.bets[1].odds);
                        const isPinned = pinnedOpportunities.has(opp.id);
                        const isBet = betOpportunities.has(opp.id);
                        return `
                            <div class="opportunity-card ${isPinned ? 'pinned' : ''} ${isBet ? 'bet' : ''}">
                                <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                            <h3 class="font-bold text-sm">${opp.homeTeam} vs ${opp.awayTeam}</h3>
                                            <div class="flex items-center gap-1">
                                                <button onclick="togglePin('${opp.id}')" class="text-gray-400 hover:text-blue-500">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                        <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/>
                                                    </svg>
                                                </button>
                                                <button onclick="toggleBet('${opp.id}')" class="text-gray-400 hover:text-green-500">
                                                    ${isBet ? 
                                                        '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>' :
                                                        '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/></svg>'
                                                    }
                                                </button>
                                            </div>
                                        </div>
                                        <div class="flex flex-wrap items-center gap-2 text-xs text-gray-600 dark:text-gray-400 mt-1">
                                            <span>${opp.sport}</span>
                                            <span>‚Ä¢</span>
                                            <span>${formatGameTime(opp.commenceTime)}</span>
                                            ${isBet ? '<span class="text-green-500">‚Ä¢ Bet Placed</span>' : ''}
                                        </div>
                                    </div>
                                    <div class="text-right mt-2 md:mt-0">
                                        <p class="font-bold text-green-500 text-sm">${opp.return.toFixed(2)}%</p>
                                        <p class="text-xs text-green-600 dark:text-green-400">$${(opp.return * parseFloat(document.getElementById('maxStake').value) / 100).toFixed(2)}</p>
                                    </div>
                                </div>
                                <div class="mt-2 space-y-2">
                                    ${opp.bets.map((bet, index) => {
                                        const odds = index === 0 ? odds1 : odds2;
                                        return `
                                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-t dark:border-gray-700 pt-2">
                                                <div>
                                                    <p class="text-sm font-medium">${bet.team}</p>
                                                    <p class="text-xs text-gray-600 dark:text-gray-400">${bet.bookmaker}</p>
                                                </div>
                                                <div class="text-right mt-1 md:mt-0">
                                                    <p class="text-sm font-medium">$${parseFloat(bet.stake).toFixed(2)}</p>
                                                    <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                                                        <span>${odds.decimal}</span>
                                                        <span>${odds.american}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                <div class="mt-2 flex justify-end gap-2">
                                    <button onclick="handleCopyDetails(${JSON.stringify(opp)})" 
                                            class="text-xs text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300">
                                        Copy Details
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function showLoading(show) {
            const button = document.getElementById('refreshButton');
            const buttonText = button.querySelector('.button-text');
            const spinner = button.querySelector('.loading-spinner');
            
            if (show) {
                button.disabled = true;
                buttonText.classList.add('hidden');
                spinner.classList.remove('hidden');
            } else {
                button.disabled = false;
                buttonText.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }

        async function updateOpportunities() {
            const sportKey = document.getElementById('sportSelect').value;
            let events = [];

            try {
                showLoading(true);
                if (sportKey === 'all') {
                    events = await fetchAllSportsOdds();
                } else {
                    events = await fetchOdds(sportKey);
                }

                // Filter events based on selected bookmakers
                events = events.filter(event => {
                    if (!event.bookmakers) return false;
                    return event.bookmakers.some(b => selectedBookmakers.has(b.title));
                });

                opportunities = findArbitrageOpportunities(events);
                displayOpportunities();
            } catch (error) {
                console.error('Error updating opportunities:', error);
                document.getElementById('opportunities').innerHTML = `
                    <div class="text-center text-red-500 py-4">
                        <p class="font-bold">Error updating opportunities</p>
                        <p class="text-sm">${error.message}</p>
                        <button onclick="updateOpportunities()" class="button mt-2">Try Again</button>
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }

        // Update the initialization section
        function startAutoRefresh() {
            // Update immediately
            updateOpportunities();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing...');
            // Load saved bookmakers and bets first
            loadSavedBookmakers();
            loadSavedBets();
            
            // Then fetch sports and start auto-refresh
            fetchSports().then(() => {
                console.log('Sports fetched, loading opportunities...');
                // Set initial sport selection to 'all'
                document.getElementById('sportSelect').value = 'all';
                // Update opportunities immediately
                updateOpportunities();
            }).catch(error => {
                console.error('Error during initialization:', error);
            });
        });

        document.getElementById('sportSelect').addEventListener('change', () => {
            console.log('Sport changed, updating opportunities...');
            updateOpportunities();
        });

        document.getElementById('minReturn').addEventListener('change', () => {
            console.log('Min return changed, updating display...');
            displayOpportunities();
        });
        
        document.getElementById('maxStake').addEventListener('change', () => {
            console.log('Max stake changed, updating display...');
            displayOpportunities();
        });
        
        document.getElementById('sortSelect').addEventListener('change', () => {
            console.log('Sort option changed, updating display...');
            displayOpportunities();
        });

        document.getElementById('minProfit').addEventListener('change', () => {
            console.log('Min profit changed, updating display...');
            displayOpportunities();
        });

        // Update styles for better mobile display
        const style = document.createElement('style');
        style.textContent = `
            @media (max-width: 768px) {
                .card { @apply p-4; }
                body { @apply p-4; }
                .text-3xl { @apply text-2xl; }
                #opportunities .border { @apply p-3; }
                .space-y-4 > * { @apply mb-3; }
                .settings-grid {
                    grid-template-columns: 1fr;
                }
            }
        `;
        document.head.appendChild(style);

        function calculateArbitrage() {
            const originalOddsInput = document.getElementById('originalOdds');
            const originalBetInput = document.getElementById('originalBetAmount');
            const hedgeOddsInput = document.getElementById('hedgeOdds');

            // Get raw input values without immediate parsing
            const originalOddsStr = originalOddsInput.value;
            const originalBetStr = originalBetInput.value;
            const hedgeOddsStr = hedgeOddsInput.value;

            // Only calculate if all fields have values
            if (!originalOddsStr || !originalBetStr || !hedgeOddsStr) {
                return;
            }

            // Parse values, allowing for negative signs and decimal points
            const originalOdds = parseFloat(originalOddsStr.replace(/[^-\d.]/g, ''));
            const originalBetAmount = parseFloat(originalBetStr.replace(/[^-\d.]/g, ''));
            const hedgeOdds = parseFloat(hedgeOddsStr.replace(/[^-\d.]/g, ''));

            if (isNaN(originalOdds) || isNaN(originalBetAmount) || isNaN(hedgeOdds)) {
                return;
            }

            // Convert American odds to decimal
            const decimalOriginal = originalOdds > 0 ? (originalOdds / 100) + 1 : (100 / Math.abs(originalOdds)) + 1;
            const decimalHedge = hedgeOdds > 0 ? (hedgeOdds / 100) + 1 : (100 / Math.abs(hedgeOdds)) + 1;

            // Calculate hedge amount to guarantee equal profit
            const hedgeAmount = (originalBetAmount * decimalOriginal) / decimalHedge;
            const totalStake = originalBetAmount + hedgeAmount;
            const guaranteedProfit = (originalBetAmount * decimalOriginal) - totalStake;

            // Update display
            document.getElementById('idealHedgeAmount').textContent = `$${hedgeAmount.toFixed(2)}`;
            document.getElementById('totalBetAmount').textContent = `$${totalStake.toFixed(2)}`;
            document.getElementById('totalProfit').textContent = `$${guaranteedProfit.toFixed(2)}`;
        }

        function resetCalculator() {
            document.getElementById('originalOdds').value = '';
            document.getElementById('originalBetAmount').value = '100';
            document.getElementById('hedgeOdds').value = '';
            document.getElementById('idealHedgeAmount').textContent = '$0.00';
            document.getElementById('totalBetAmount').textContent = '$0.00';
            document.getElementById('totalProfit').textContent = '$0.00';
        }

        // Add event listeners for calculator inputs with debounce
        let timeoutId;
        ['originalOdds', 'originalBetAmount', 'hedgeOdds'].forEach(id => {
            const input = document.getElementById(id);
            input.addEventListener('input', () => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    calculateArbitrage();
                    saveCalculatorState();
                }, 300);
            });
        });

        // Add pin/unpin functions
        function togglePin(opportunityId) {
            const opportunity = opportunities.find(opp => opp.id === opportunityId);
            if (!opportunity) return;

            if (pinnedOpportunities.has(opportunityId)) {
                pinnedOpportunities.delete(opportunityId);
            } else {
                pinnedOpportunities.set(opportunityId, opportunity);
            }

            displayOpportunities();
        }

        function displayPinnedOpportunities() {
            const container = document.getElementById('pinnedOpportunities');
            const pinnedContainer = container.querySelector('.pinned-container');

            if (pinnedOpportunities.size === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            pinnedContainer.innerHTML = Array.from(pinnedOpportunities.values()).map(opp => {
                const odds1 = formatOdds(opp.bets[0].odds);
                const odds2 = formatOdds(opp.bets[1].odds);
                return `
                    <div class="opportunity-card border-2 border-blue-500 rounded p-3 bg-white shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <h3 class="font-bold text-sm">${opp.homeTeam} vs ${opp.awayTeam}</h3>
                                    <button onclick="togglePin('${opp.id}')" class="text-blue-500 hover:text-blue-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/>
                                        </svg>
                                    </button>
                                </div>
                                <div class="flex flex-wrap items-center gap-2 text-xs text-gray-600 mt-1">
                                    <span>${opp.sport}</span>
                                    <span>‚Ä¢</span>
                                    <span>${formatGameTime(opp.commenceTime)}</span>
                                </div>
                            </div>
                            <div class="text-right mt-2 md:mt-0">
                                <p class="font-bold text-green-500 text-sm">${opp.return.toFixed(2)}%</p>
                                <p class="text-xs text-green-600">$${(opp.return * parseFloat(document.getElementById('maxStake').value) / 100).toFixed(2)}</p>
                            </div>
                        </div>
                        <div class="mt-2 space-y-2">
                            ${opp.bets.map((bet, index) => {
                                const odds = index === 0 ? odds1 : odds2;
                                return `
                                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-t pt-2">
                                        <div>
                                            <p class="text-sm font-medium">${bet.team}</p>
                                            <p class="text-xs text-gray-600">${bet.bookmaker}</p>
                                        </div>
                                        <div class="text-right mt-1 md:mt-0">
                                            <p class="text-sm font-medium">$${parseFloat(bet.stake).toFixed(2)}</p>
                                            <div class="flex items-center gap-2 text-xs text-gray-500">
                                                <span>${odds.decimal}</span>
                                                <span>${odds.american}</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + R to refresh
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                updateOpportunities();
            }
            // Ctrl/Cmd + D to toggle dark mode
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                toggleDarkMode();
            }
        });

        // Save calculator state to localStorage
        function saveCalculatorState() {
            const state = {
                originalOdds: document.getElementById('originalOdds').value,
                originalBetAmount: document.getElementById('originalBetAmount').value,
                hedgeOdds: document.getElementById('hedgeOdds').value
            };
            localStorage.setItem('calculatorState', JSON.stringify(state));
        }

        function loadCalculatorState() {
            const saved = localStorage.getItem('calculatorState');
            if (saved) {
                const state = JSON.parse(saved);
                document.getElementById('originalOdds').value = state.originalOdds;
                document.getElementById('originalBetAmount').value = state.originalBetAmount;
                document.getElementById('hedgeOdds').value = state.hedgeOdds;
                calculateArbitrage();
            }
        }

        // Dark mode support
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
        }

        function initDarkMode() {
            if (localStorage.getItem('darkMode') === 'true' || 
                (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        }

        // Scroll to top function
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Initialize dark mode on page load
        document.addEventListener('DOMContentLoaded', () => {
            initDarkMode();
            loadCalculatorState();
            // ... rest of existing DOMContentLoaded code ...
        });

        // Load saved bet opportunities from localStorage
        function loadSavedBets() {
            const saved = localStorage.getItem('betOpportunities');
            if (saved) {
                betOpportunities = new Set(JSON.parse(saved));
            }
        }

        function saveBets() {
            localStorage.setItem('betOpportunities', JSON.stringify(Array.from(betOpportunities)));
        }

        function toggleBet(opportunityId) {
            if (betOpportunities.has(opportunityId)) {
                betOpportunities.delete(opportunityId);
            } else {
                betOpportunities.add(opportunityId);
            }
            saveBets();
            displayOpportunities();
        }
    </script>
</body>
</html> 